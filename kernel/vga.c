#include "memlayout.h"
#include "types.h"
#include "defs.h"
#include "x86.h"
#include "vga.h"

#define peekb(S,O)			*(unsigned char *)(P2V(16uL * (S) + (O)))
#define pokeb(S,O,V)		*(unsigned char *)(P2V(16uL * (S) + (O))) = (V)
#define pokew(S,O,V)		*(unsigned short *)(P2V(16uL * (S) + (O)))= (V)

#define vpokeb(off, val)	pokeb(get_fb_seg(), off, val)
#define vpeekb(off)			peekb(get_fb_seg(), off)

#define VGA_AC_INDEX		0x3c0
#define VGA_AC_WRITE		0x3c0
#define VGA_AC_READ			0x3c1
#define VGA_MISC_WRITE		0x3c2
#define VGA_SEQ_INDEX		0x3c4
#define VGA_SEQ_DATA		0x3c5
#define VGA_DAC_READ_INDEX	0x3c7
#define VGA_DAC_WRITE_INDEX	0x3c8
#define VGA_DAC_DATA		0x3c9
#define VGA_MISC_READ		0x3cc
#define VGA_GC_INDEX		0x3ce
#define VGA_GC_DATA			0x3cf

#define VGA_CRTC_INDEX		0x3d4
#define VGA_CRTC_DATA		0x3d5
#define VGA_INSTAT_READ		0x3da

#define VGA_NUM_SEQ_REGS	5
#define VGA_NUM_CRTC_REGS	25
#define VGA_NUM_GC_REGS		9
#define VGA_NUM_AC_REGS		21
#define VGA_NUM_REGS		(1 + VGA_NUM_SEQ_REGS + VGA_NU<_CRTC_REGS + \
		VGA_NUM_GC_REGS + VGA_NUM_AC_REGS)

unsigned char g_320x200x4[] =
{
/* MISC */
	0x63,
/* SEQ */
	0x03, 0x09, 0x03, 0x00, 0x02,
/* CRTC */
	0x2D, 0x27, 0x28, 0x90, 0x2B, 0x80, 0xBF, 0x1F,
	0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x9C, 0x0E, 0x8F, 0x14, 0x00, 0x96, 0xB9, 0xA3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x02, 0x00,
	0xFF,
/* AC */
	0x00, 0x13, 0x15, 0x17, 0x02, 0x04, 0x06, 0x07,
	0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
	0x01, 0x00, 0x03, 0x00, 0x00
};

unsigned char g_640x480x16[] =
{
/* MISC */
	0xE3,
/* SEQ */
	0x03, 0x01, 0x08, 0x00, 0x06,
/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0x0B, 0x3E,
	0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xEA, 0x0C, 0xDF, 0x28, 0x00, 0xE7, 0x04, 0xE3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x05, 0x0F,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x14, 0x07,
	0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F,
	0x01, 0x00, 0x0F, 0x00, 0x00
};

unsigned char g_720x480x16[] =
{
/* MISC */
	0xE7,
/* SEQ */
	0x03, 0x01, 0x08, 0x00, 0x06,
/* CRTC */
	0x6B, 0x59, 0x5A, 0x82, 0x60, 0x8D, 0x0B, 0x3E,
	0x00, 0x40, 0x06, 0x07, 0x00, 0x00, 0x00, 0x00,
	0xEA, 0x0C, 0xDF, 0x2D, 0x08, 0xE8, 0x05, 0xE3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x05, 0x0F,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x01, 0x00, 0x0F, 0x00, 0x00,
};

unsigned char g_320x200x256[] =
{
/* MISC */
	0x63,
/* SEQ */
	0x03, 0x01, 0x0F, 0x00, 0x0E,
/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F,
	0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x9C, 0x0E, 0x8F, 0x28,	0x40, 0x96, 0xB9, 0xA3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x41, 0x00, 0x0F, 0x00,	0x00
};

unsigned char g_320x200x256_modex[] =
{
/* MISC */
	0x63,
/* SEQ */
	0x03, 0x01, 0x0F, 0x00, 0x06,
/* CRTC */
	0x5F, 0x4F, 0x50, 0x82, 0x54, 0x80, 0xBF, 0x1F,
	0x00, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x9C, 0x0E, 0x8F, 0x28, 0x00, 0x96, 0xB9, 0xE3,
	0xFF,
/* GC */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x05, 0x0F,
	0xFF,
/* AC */
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
	0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F,
	0x41, 0x00, 0x0F, 0x00, 0x00
};

void vga_setmode(const enum vga_mode_t mode){
	switch(mode){
	case VGA_320x200x4:
		vga_write_regs(g_320x200x4);
		break;
	case VGA_640x480x16:
		vga_write_regs(g_640x480x16);
		break;
	case VGA_720x480x16:
		vga_write_regs(g_720x480x16);
		break;
	case VGA_320x200x256:
		vga_write_regs(g_320x200x256);
		break;
	case VGA_320x200x256_x:
		vga_write_regs(g_320x200x256_modex);
		break;
	}
}

// 0:黒
// 1:青
// 2:緑
// 3:水色?
// 4:赤
// 5:赤紫
// 6:黄色
// 7:白

// demo func
void demo_graphics(void){
	cprintf("demo start\n");
	vga_write_regs(g_320x200x256);

//	while(1);

	unsigned center_x = 320 / 2;
	unsigned center_y = 200 / 2;

	draw_box(0, 0, 320, 200, 0);

	draw_circle(center_x, center_y, 37, 1);
	draw_circle(center_x, center_y, 35, 7);
	draw_circle(center_x, center_y, 25, 1);
	draw_circle(center_x, center_y, 20, 0);
	draw_circle(center_x, center_y, 15, 1);
	draw_circle(center_x, center_y, 10, 7);

	for(unsigned y=0;y<200;y++){
		draw_pixel((320 - 200) / 2 + y, y, 2);
	}

	cprintf("demo end\n");
//	while(1);
}

void vga_write_regs(unsigned char *regs){
	unsigned i;
	outb(VGA_MISC_WRITE, *regs);
	regs++;

	for(i=0;i<VGA_NUM_SEQ_REGS;i++){
		outb(VGA_SEQ_INDEX, i);
		outb(VGA_SEQ_DATA, *regs);
		regs++;
	}

	outb(VGA_CRTC_INDEX, 0x03);
	outb(VGA_CRTC_DATA, inb(VGA_CRTC_DATA) | 0x80);
	outb(VGA_CRTC_INDEX, 0x11);
	outb(VGA_CRTC_DATA, inb(VGA_CRTC_DATA) & ~0x80);

	regs[0x03] |= 0x80;
	regs[0x11] &= ~0x80;

	for(i=0;i<VGA_NUM_CRTC_REGS;i++){
		outb(VGA_CRTC_INDEX, i);
		outb(VGA_CRTC_DATA, *regs);
		regs++;
	}

	for(i=0;i<VGA_NUM_GC_REGS;i++){
		outb(VGA_GC_INDEX, i);
		outb(VGA_GC_DATA, *regs);
		regs++;
	}

	for(i=0;i<VGA_NUM_AC_REGS;i++){
		(void)inb(VGA_INSTAT_READ);
		outb(VGA_AC_INDEX, i);
		outb(VGA_AC_WRITE, *regs);
		regs++;
	}

	(void)inb(VGA_INSTAT_READ);
	outb(VGA_AC_INDEX, 0x20);
}

unsigned get_fb_seg(void){
	unsigned seg;

	outb(VGA_GC_INDEX, 6);
	seg = inb(VGA_GC_DATA);
	seg >>= 2;
	seg &= 3;

	switch(seg){
	case 0:
	case 1:
		seg = 0xa000;
		break;
	case 2:
		seg = 0xb000;
		break;
	case 3:
		seg = 0xb800;
		break;
	}

	return seg;
}

// 320x200x4
//
/*
void write_pixel2(unsigned x, unsigned y, unsigned c){
	unsigned wd_in_bytes, off, mask;

	c = (c & 3) * 0x55;
	wd_in_bytes = 320 / 4;
	off = wd_in_bytes * y + x / 4;
	x = (x & 3) * 2;
	mask = 0xc0 >> x;
	vpokeb(off, (vpeekb(off) & ~mask) | (c & mask));
}
*/

void draw_pixel(unsigned x, unsigned y, unsigned c){
	unsigned wd_in_bytes;
	unsigned off;
	wd_in_bytes = 320;
	off = wd_in_bytes * y + x;
	vpokeb(off, c);
}

void draw_box(unsigned x1, unsigned y1, unsigned x2, unsigned y2, unsigned c){
	for(unsigned y=0;y<200;y++){
		for(unsigned x=0;x<320;x++){
			draw_pixel(x, y, c);
		}
	}
}

void draw_circle(unsigned xpos, unsigned ypos, unsigned r, unsigned c){
	for(unsigned y=0;y<200;y++){
		for(unsigned x=0;x<320;x++){
			if((xpos-x)*(xpos-x) + (ypos-y)*(ypos-y) < r*r)
				draw_pixel(x, y, c);
		}
	}
}
